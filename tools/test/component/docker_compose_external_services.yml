version: '2.1'

# See external_services_env_vars.sh for env vars used in this file

services:
    ${ELASTIC_OTEL_PHP_TESTS_MYSQL_HOST}:
        image: mysql:8.0
        restart: always
        environment:
            - MYSQL_DATABASE=${ELASTIC_OTEL_PHP_TESTS_MYSQL_DB}
            - MYSQL_ROOT_PASSWORD=${ELASTIC_OTEL_PHP_TESTS_MYSQL_PASSWORD}
        command: mysqld --character-set-server=utf8 --collation-server=utf8_unicode_ci --default-authentication-plugin=mysql_native_password
        healthcheck:
            test: [ "CMD", "mysqladmin", "--host=localhost", "--user=${ELASTIC_OTEL_PHP_TESTS_MYSQL_USER}", "--password=${ELASTIC_OTEL_PHP_TESTS_MYSQL_PASSWORD}", "ping" ]
            timeout: 5s
            retries: 60
        networks:
            - ${ELASTIC_OTEL_PHP_TESTS_DOCKER_NETWORK}

    elastic-otel-php-tests-component-wait-for-all-services-to-start:
        image: busybox
        depends_on:
            ${ELASTIC_OTEL_PHP_TESTS_MYSQL_HOST}:
                condition: service_healthy

networks:
    ${ELASTIC_OTEL_PHP_TESTS_DOCKER_NETWORK}:
        name: ${ELASTIC_OTEL_PHP_TESTS_DOCKER_NETWORK}
        driver: bridge
