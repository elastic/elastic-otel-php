#!/usr/bin/env bash
set -e -u -o pipefail
#set -x

function main() {
    repo_root_dir="$(realpath "${PWD}")"
    source "${repo_root_dir}/tools/shared.sh"

    # ./tools/build/configure_php_templates.sh must be called before any .php scripts in ./tools/build/
    # because .php scripts in ./tools/build/ depend on some of .php source files
    # generated by ./tools/build/configure_php_templates.sh
    ./tools/build/configure_php_templates.sh

    php ./tools/build/verify_generated_composer_lock_files.php

    php ./tools/build/select_composer_lock_and_install.php dev
    php ./tools/build/select_composer_lock_and_install.php prod

    local vendor_prod_dir="${repo_root_dir}/${elastic_otel_php_vendor_prod_dir_name:?}"
    ./tools/build/scope_PHP_deps.sh --input_dir "${vendor_prod_dir}" --output_dir "${vendor_prod_dir}"
}

main "$@"
