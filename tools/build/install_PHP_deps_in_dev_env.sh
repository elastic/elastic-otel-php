#!/usr/bin/env bash
set -e -u -o pipefail
#set -x

function main() {
    work_repo_root_dir="$(realpath "${PWD}")"
    this_script_dir="$(dirname "${BASH_SOURCE[0]}")"
    this_script_dir="$(realpath "${this_script_dir}")"
    src_repo_root_dir="$(realpath "${this_script_dir}/../..")"

    source "${src_repo_root_dir}/tools/shared.sh"

    # ./tools/build/configure_php_templates.sh must be called before any .php scripts in ./tools/build/
    # because .php scripts in ./tools/build/ depend on some of .php source files
    # generated by ./tools/build/configure_php_templates.sh
    "${src_repo_root_dir}/tools/build/configure_php_templates.sh"

    php "${src_repo_root_dir}/tools/build/verify_generated_composer_lock_files.php"

    php "${src_repo_root_dir}/tools/build/select_composer_lock_and_install.php" dev
    php "${src_repo_root_dir}/tools/build/select_composer_lock_and_install.php" prod

    local dst_vendor_prod_dir="${work_repo_root_dir}/${elastic_otel_php_vendor_prod_dir_name:?}"
    "${src_repo_root_dir}/tools/build/scope_PHP_deps.sh" --input_dir "${dst_vendor_prod_dir}" --output_dir "${dst_vendor_prod_dir}"
}

main "$@"
