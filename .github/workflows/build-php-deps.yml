---

name: build-php-deps

on:
  workflow_call: ~
  workflow_dispatch: ~

jobs:
  build-php-deps:
    name: build-php-dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 300
    strategy:
      fail-fast: false
    env:
      COMPOSER_ALLOW_SUPERUSER: 1
    steps:
      - uses: actions/checkout@v4
      - name: Build PHP dependencies
        run: |
          uname -a

          PHP_VERSIONS=( 80 81 82 83 )

          for PHP_VERSION in "${PHP_VERSIONS[@]}"
          do
            mkdir -p "prod/php/vendor_${PHP_VERSION}"

            echo "This project depends on folliwng packages for PHP ${PHP_VERSION}" >>NOTICE

            docker run --rm \
              -v ${PWD}:/sources \
              -v ${PWD}/prod/php/vendor_${PHP_VERSION}:/sources/vendor \
              -w /sources \
              php:${PHP_VERSION:0:1}.${PHP_VERSION:1:1}-cli sh -c "apt-get update && apt-get install -y unzip && curl -sS https://getcomposer.org/installer | php -- --filename=composer --install-dir=/usr/local/bin && composer --ignore-platform-req=ext-opentelemetry --ignore-platform-req=ext-otel_instrumentation --no-dev install && php /sources/packaging/notes_generator.php >>/sources/NOTICE"

              rm composer.lock

          done

      - uses: actions/upload-artifact@v4
        with:
          name: php-dependencies
          path: |
            prod/php/vendor_*
            NOTICE
